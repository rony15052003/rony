apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: node-web-app-tt # pipeline-template
spec:
  params:
  - name: gitrevision
    description: The git revision
    default: main
  - name: gitrepositoryurl
    description: The git repository url
  - name: message
    description: The message to print
    default: This is the default message
  - name: contenttype
    description: The Content-Type of the event
  resourcetemplates:
  - apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      generateName: node-web-app-pipeline-run-
    spec:
      serviceAccountName: build-bot
      pipelineRef:
        name: node-web-app-pipeline
      podTemplate:
        securityContext:
          fsGroup: 65532
      workspaces:
      - name: shared-data
        volumeClaimTemplate:
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
      - name: git-credentials
        secret:
          secretName: git-credentials
      - name: nexus-credentials
        secret:
          secretName: docker-credentials-secret #nexus-credentials
      params:
      - name: repo-url
        value: https://github.com/kriztobal/node-web-app.git # https://github.com/kriztobal/react-tekton-argo.git
      - name: image-reference
        value: becariodocker/react-app:1.0.1 # 192.168.162.161:8082/repository/project/test-app:1.0.1

# apiVersion: triggers.tekton.dev/v1beta1 #apiVersion: tekton.dev/v1alpha1
# kind: TriggerTemplate
# metadata:
#   name: node-web-app-tt
# spec:
#   params: 
#   - name: git-repo-url
#     default: main # master
#   - name: git-repo-name
#   - name: git-revision
#   resourcetemplates:
#   - apiVersion: tekton.dev/v1beta1
#     kind: PipelineRun
#     metadata:
#       generateName: node-web-app-pipeline-run-
#     spec:
#       serviceAccountName: build-bot
#       pipelineRef:
#         name: node-web-app-pipeline
#       podTemplate:
#         securityContext:
#           fsGroup: 65532
#       workspaces:
#       - name: shared-data
#         volumeClaimTemplate:
#           spec:
#             accessModes:
#             - ReadWriteOnce
#             resources:
#               requests:
#                 storage: 1Gi
#       - name: git-credentials
#         secret:
#           secretName: git-credentials
#       - name: nexus-credentials
#         secret:
#           secretName: docker-credentials-secret #nexus-credentials
#       params:
#       - name: repo-url
#         value: https://github.com/kriztobal/node-web-app.git # https://github.com/kriztobal/react-tekton-argo.git
#       - name: image-reference
#         value: becariodocker/react-app:1.0.1 # 192.168.162.161:8082/repository/project/test-app:1.0.1

--- 

apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: node-web-app-tb # pipeline-binding
spec:
  params:
  - name: gitrevision
    value: $(body.head_commit.id)
  - name: gitrepositoryurl
    value: $(body.repository.url)
  - name: contenttype
    value: $(header.Content-Type)

# apiVersion: tekton.dev/v1alpha1
# kind: TriggerBinding
# metadata:
#   name: node-web-app-tb
# spec:
#   params:
#   - name: git-repo-url
#     value: $(body.repository.url)
#   - name: git-revision
#     value: $(body.head_commit.id)
#   - name: git-repo-name
#     value: $(body.repository.name)

---

apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: trigger
spec:
  interceptors:
    - ref:
        name: "cel"
      params:
        - name: "filter"
          value: "header.match('X-GitHub-Event', 'pull_request')"
        - name: "overlays"
          value:
            - key: extensions.truncated_sha
              expression: "body.pull_request.head.sha.truncate(7)"
  bindings:
  - ref: node-web-app-tb # pipeline-binding
  template:
    ref: node-web-app-tt # pipeline-template

---

apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: node-web-app-el # eventlistener
spec:
  triggers:
    - name: trigger
      serviceAccountName: build-bot # pipeline # trigger-sa
      interceptors:
        - github:
            eventTypes: ["pull_request"]
      bindings:
        - ref: node-web-app-tb # pipeline-binding
      template:
        ref: node-web-app-tt # pipeline-template

# apiVersion: tekton.dev/v1alpha1
# kind: EventListener
# metadata:
#   name: node-web-app-el
# spec:
#   serviceAccountName: pipeline
#   triggers:
#   - bindings:
#     - name: node-web-app-tb
#     template:
#       name: node-web-app-tt

---

# apiVersion: route.openshift.io/v1
# kind: Route
# metadata:
#   name: el-node-web-app
#   namespace: node-web-project
# spec:
#   host: el-node-web-app.apps.roly-ocp43-cluster.roly-ocp.com
#   to:
#     kind: Service
#     name: el-node-web-app-el
#     weight: 100